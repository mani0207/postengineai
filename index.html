<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>postEngineAI ‚Äî Free demo (2 captions)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase Auth (email/password + Google) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7"></script>
  <meta name="supabase-url" content="https://gstimoeysvzskmrnehfv.supabase.co">
  <meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdGltb2V5c3Z6c2ttcm5laGZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIwODgsImV4cCI6MjA3MzM5ODA4OH0.Pe9RUEHM1xK2qqK7n13M7ErAgZcuAVSGXDq1Yr2aP1o">
  <style>
    :root{--ig:linear-gradient(90deg,#F58529,#DD2A7B,#8134AF)}
    .ig{background-image:var(--ig)}
    .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .chip{display:inline-block;background:#0e141b;color:#fff;border-radius:9999px;padding:.45rem .8rem}
  </style>
</head>
<body class="bg-slate-950 text-white">
  <header class="border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <img src="/header-logo-tight.png" alt="postEngineAI" class="h-8 w-auto">
        <span class="font-semibold text-lg bg-gradient-to-r from-[#F58529] via-[#DD2A7B] to-[#8134AF] bg-clip-text text-transparent">postEngineAI</span>
      </a>
      <nav class="text-sm flex items-center gap-3">
        <a href="#" id="openAuthLink" class="opacity-90 hover:opacity-100">Sign in</a>
        <a href="/pay.html" class="rounded-lg bg-white text-black px-3 py-1.5 font-medium hover:opacity-90">Go Pro</a>
      </nav>
    </div>
  </header>

<div id="sbBanner" class="hidden bg-red-500/15 text-red-200 text-sm px-4 py-2 text-center">
  Auth not configured: Set <code>supabase-url</code> in &lt;meta&gt; in &lt;head&gt; to enable Sign in / Sign up.
</div>


  <section class="ig">
    <div class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="text-3xl sm:text-4xl font-bold">Generate scroll-stopping captions ‚Äî in seconds</h1>
<p class="mt-2 text-white/90">‚ú® Try <b>20 free captions</b>. Upgrade to <b>200/month for $5</b>.</p>

<div class="mt-4">
  <button onclick="openAuth()" class="rounded-xl bg-white text-black px-5 py-3 font-semibold text-lg hover:opacity-90">
    ‚ú® Get 20 Free Captions
  </button>
</div>

<div class="mt-4 inline-flex items-center gap-2 bg-black/30 border border-white/10 rounded-xl px-3 py-2">
  <span>Captions left:</span><span id="credits">2</span>
</div>

      <div class="mt-6 p-6 rounded-2xl border border-white/10 glass">
        <label class="block text-sm opacity-90">Describe your niche or post idea</label>
        <input id="topic" class="mt-2 w-full rounded-xl bg-black/30 border border-white/10 px-4 py-3 outline-none" placeholder="e.g., pet grooming tips, morning workout motivation" />
        
        <!-- Media options (optional image; location auto on server) -->
        <div class="mt-4 grid gap-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-2">
            <label for="media" class="text-sm opacity-90">Optional image or video (‚â§30s)</label>
            <input id="media" type="file" accept="image/*,video/*" class="text-sm file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-white file:text-black file:font-medium">
          </div>
          <img id="imgPreview" class="hidden mt-1 max-h-40 rounded-lg border border-white/10" alt="Selected image preview" />
          <video id="videoPreview" class="hidden mt-1 max-h-40 rounded-lg border border-white/10"
  controls></video>
          <div id="audioBox" class="hidden mt-4">
            <div class="text-sm opacity-90 mb-2">üéµ Background music (royalty-free)</div>
            <div class="flex gap-2 mb-2 flex-wrap">
              <button class="chip" data-mood="calm">Calm</button>
              <button class="chip" data-mood="energetic">Energetic</button>
              <button class="chip" data-mood="cinematic">Cinematic</button>
              <button class="chip" data-mood="vlog">Vlog</button>
            </div>
            <div id="audioList" class="grid gap-2"></div>

<p class="mt-2 text-xs text-white/70">
  ‚ÑπÔ∏è Background music is optional. You can export without audio or replace it later.
  <span class="opacity-60">Advanced audio editing is available in Pro.</span>
</p>
          </div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <button id="go" class="rounded-xl bg-white text-black px-4 py-2 font-medium hover:opacity-90">Generate</button>
          <button id="exportBtn" class="rounded-xl border border-white/20 px-4 py-2 font-medium hover:bg-white/10">Export video</button>
          <span id="hint" class="opacity-80 text-sm"></span>
        </div>
        <div id="out" class="mt-6 grid gap-4"></div>
      </div>
    </div>
  </section>

  <!-- Auth Modal -->
  <div id="authBackdrop" class="hidden fixed inset-0 z-50 bg-black/60"></div>
  <div id="authModal" class="hidden fixed inset-0 z-50 flex items-center justify-center px-4">
    <div class="w-full max-w-md rounded-2xl border border-white/10 bg-black/85 text-white backdrop-blur p-6">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Create your account</h3>
        <button id="authClose" class="text-white/70 hover:text-white">‚úï</button>
      </div>
      <p class="mt-1 text-sm text-white/80">Sign up to unlock your <b>20-caption free trial</b>.</p>
      <div class="mt-4 grid gap-3">
        <input id="authEmail" type="email" placeholder="you@example.com" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
        <input id="authPass" type="password" placeholder="Password (min 6 chars)" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
        <button id="authSignup" class="rounded-lg bg-white text-black px-3 py-2 font-medium">Sign up</button>
        <button id="authSignin" class="rounded-lg border border-white/20 px-3 py-2 font-medium hover:bg-white/10">I already have an account</button>
        <div class="text-center text-sm text-white/60">or</div>
        <button id="authGoogle" class="rounded-lg bg-[#4285F4] px-3 py-2 font-medium">Continue with Google</button>
        <div class="flex items-center justify-between text-sm">
  <button id="forgotPass" class="underline text-white/80 hover:text-white">Forgot password?</button>
  <button id="useGoogleHint" class="underline text-white/80 hover:text-white">Signed up with Google?</button>
</div>
<p id="authMsg" class="text-sm text-white/80 mt-2"></p>
      </div>
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // üîí Force guest mode on index.html (never allow logged-in state here)
    document.cookie = 'pe_auth=; Max-Age=0; Path=/';
    console.log('index.html DOM ready');
    const FFMPEG_API = 'https://periproctic-maricela-nonpatently.ngrok-free.dev/export';
    const FFMPEG_IMAGE_API = 'https://periproctic-maricela-nonpatently.ngrok-free.dev/export-image';
  // Helpers
  function setCookie(k,v,days){const d=new Date();d.setTime(d.getTime()+days*864e5);document.cookie=k+'='+encodeURIComponent(v)+';expires='+d.toUTCString()+';path=/;SameSite=Lax';}
  function getCookie(k){return document.cookie.split(';').map(s=>s.trim()).filter(Boolean).reduce((a,p)=>{const[i,...r]=p.split('=');a[i]=decodeURIComponent(r.join('='));return a;}, {})[k];}
  const C_KEY='pe_anon';
  function safeUUID() {
  return 'pe_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
}

if (!getCookie(C_KEY)) {
  setCookie(C_KEY, safeUUID(), 365);
}

  const creditsEl = document.getElementById('credits');

  function getCredits(){
    const v = parseInt(localStorage.getItem('pe_guest_credits') || '2', 10);
    return Math.max(0, Math.min(2, v)); // hard cap at 2
  }

  function setCredits(n){
    const v = Math.max(0, Math.min(2, n)); // hard cap at 2
    localStorage.setItem('pe_guest_credits', String(v));
    creditsEl.textContent = v;
  }

  setCredits(getCredits());

  const topic = document.getElementById('topic');
  const go = document.getElementById('go');
  const hint = document.getElementById('hint');
  const out = document.getElementById('out');

  // Image -> DataURL helper
  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  const mediaInput = document.getElementById('media');
  const imgPreview = document.getElementById('imgPreview');
  const videoPreview = document.getElementById('videoPreview');
let mediaType = null;
let selectedAudio = null; // SINGLE source of truth for guest audio
window._videoFrames = [];

  if (mediaInput) {
    mediaInput.addEventListener('change', async () => {
      const f = mediaInput.files && mediaInput.files[0];
      if (!f) {
        mediaType = null;
        imgPreview.classList.add('hidden');
        videoPreview.classList.add('hidden');
        document.getElementById('audioBox').classList.add('hidden');
        selectedAudio = null;
        return;
      }

      if (f.type.startsWith('image/')) {
        mediaType = 'image';
        const url = await fileToDataUrl(f);
        imgPreview.src = url;
        imgPreview.classList.remove('hidden');
        videoPreview.classList.add('hidden');
        document.getElementById('audioBox').classList.remove('hidden');
        selectedAudio = null;
      }

      if (f.type.startsWith('video/')) {
        mediaType = 'video';
        videoPreview.src = URL.createObjectURL(f);
        videoPreview.classList.remove('hidden');
        imgPreview.classList.add('hidden');
        document.getElementById('audioBox').classList.remove('hidden');

        videoPreview.onloadedmetadata = () => {
          if (videoPreview.duration > 30) {
            alert('Video must be 30 seconds or less');
            mediaInput.value = '';
            mediaType = null;
            videoPreview.classList.add('hidden');
            window._videoFrames = [];
            document.getElementById('audioBox').classList.add('hidden');
            selectedAudio = null;
            return;
          }

          // Sample frames: 1 frame per second, max 8 frames
          window._videoFrames = [];
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          canvas.width = videoPreview.videoWidth;
          canvas.height = videoPreview.videoHeight;

          const maxFrames = Math.min(8, Math.floor(videoPreview.duration));
          let t = 0;

          videoPreview.onseeked = () => {
            ctx.drawImage(videoPreview, 0, 0, canvas.width, canvas.height);
            window._videoFrames.push(canvas.toDataURL('image/jpeg', 0.6));
            t++;
            if (t < maxFrames) videoPreview.currentTime = t;
          };

          videoPreview.currentTime = 0;
        };
      }
    });
  }
  // --- Audio picker logic ---
  async function loadAudio(mood) {
    const list = document.getElementById('audioList');
    hint.textContent = `Loading ${mood} music‚Ä¶`;
    list.innerHTML = '<div class="opacity-70">Loading tracks‚Ä¶</div>';
    try {
      const r = await fetch('/api/audio-search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mood })
      });
      if (!r.ok) throw new Error(`Audio API ${r.status}`);
      const data = await r.json();
      const items = Array.isArray(data) ? data : (data.results || []);
      console.log('üéß Audio items loaded:', items);
      if (!items.length) {
        list.innerHTML = '<div class="opacity-70">No tracks found. Try another mood.</div>';
        hint.textContent = 'No music found for this mood.';
        return;
      }
      list.innerHTML = '';
      let autoSelected = false;

      items.slice(0, 5).forEach((a, idx) => {
        const row = document.createElement('div');
        row.className = 'flex items-center gap-2 bg-black/30 border border-white/10 rounded-lg p-2';

        const audio = document.createElement('audio');
        audio.src = a.preview;
        audio.controls = true;

        const use = document.createElement('button');
        use.className = 'rounded-lg border border-white/20 px-3 py-1.5 text-sm';
        use.textContent = 'Use';
        use.onclick = () => {
          selectedAudio = { preview: a.preview };
          console.log('üéµ Selected audio:', selectedAudio);
          [...list.children].forEach(c => c.classList.remove('ring-2','ring-white'));
          row.classList.add('ring-2','ring-white');
          hint.textContent = 'Background music selected ‚úì';
        };

        row.appendChild(audio);
        row.appendChild(use);
        list.appendChild(row);

        // auto-select FIRST item after render
        if (!autoSelected && idx === 0 && a.preview) {
          selectedAudio = { preview: a.preview };
          row.classList.add('ring-2','ring-white');
          autoSelected = true;
          console.log('üéµ Auto-selected audio:', selectedAudio);
          hint.textContent = 'Background music auto-selected ‚úì';
        }
      });
      if (selectedAudio) hint.textContent = 'Background music ready ‚úì';
    } catch (e) {
      list.innerHTML = '<div class="opacity-70">Failed to load audio</div>';
      hint.textContent = 'Failed to load audio.';
    }
  }

  document.querySelectorAll('#audioBox [data-mood]').forEach(btn => {
    btn.onclick = () => loadAudio(btn.dataset.mood);
  });


  
  // Supabase init (for signup)
  const SUPABASE_URL  = (document.querySelector('meta[name="supabase-url"]')||{}).content || '';
  const SUPABASE_ANON = (document.querySelector('meta[name="supabase-anon"]')||{}).content || '';
  let supabase = null;
  try {
    if (SUPABASE_URL && SUPABASE_ANON && window.supabase && window.supabase.createClient) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
    }
  } catch (e) {
    console.error('Supabase init failed', e);
  }

  // Show a banner if no Supabase URL so you know why Sign in doesn't redirect
  (function(){
    const b=document.getElementById('sbBanner');
    if(!b) return;
    if(!SUPABASE_URL || !SUPABASE_ANON){ b.classList.remove('hidden'); }
  })();

  function show(id){document.getElementById(id).classList.remove('hidden');}
  function hide(id){document.getElementById(id).classList.add('hidden');}
  function openAuth(){ show('authBackdrop'); show('authModal'); }
  function closeAuth(){ hide('authBackdrop'); hide('authModal'); document.getElementById('authMsg').textContent=''; }
  window.openAuth = openAuth;
  window.closeAuth = closeAuth;
  const authCloseBtn = document.getElementById('authClose');
  if (authCloseBtn) authCloseBtn.onclick = closeAuth;

  const openAuthLinkEl = document.getElementById('openAuthLink');
  if (openAuthLinkEl) openAuthLinkEl.onclick = (e)=>{ e.preventDefault(); openAuth(); };

  async function redirectToApp(){ window.location.href = '/app.user.html'; }

  async function onSignedIn(email){ 
    document.cookie = 'pe_auth=1; Path=/; SameSite=Lax; Max-Age='+(60*60*24*180);
    try{ await fetch('/api/early-access', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, niche:'Trial', source:'Guest modal' }) }); }catch{}
    await redirectToApp();
  }

  const authSignupBtn = document.getElementById('authSignup');
  if (authSignupBtn) authSignupBtn.onclick = async () => {
    if (!supabase) {
      document.getElementById('authMsg').textContent = 'Auth not configured (missing Supabase URL/Key).';
      return;
    }
    const email = document.getElementById('authEmail').value.trim();
    const pass  = document.getElementById('authPass').value;
    const msg   = document.getElementById('authMsg');

    // Ask Supabase to send a confirm email that redirects back to your app
    const { data, error } = await supabase.auth.signUp({
      email,
      password: pass,
      options: {
        emailRedirectTo: window.location.origin + '/app.user.html'
      }
    });

    if (error) { msg.textContent = error.message; return; }

    // DO NOT redirect here. Wait for the user to confirm.
    msg.innerHTML = `
      ‚úÖ Check your inbox to confirm your email.<br/>
      After confirming, you‚Äôll be signed in and redirected automatically.
      <br/><br/>
      <button id="resendConfirm" class="underline">Resend confirmation email</button>
    `;

    const resendBtn = document.getElementById('resendConfirm');
    if (resendBtn) {
      resendBtn.onclick = async () => {
        try {
          // Supabase doesn‚Äôt have a direct ‚Äúresend confirm‚Äù helper;
          // triggering signUp again with the same email will send another email (and no new user will be created).
          const r = await supabase.auth.signUp({
            email,
            password: pass,
            options: { emailRedirectTo: window.location.origin + '/app.user.html' }
          });
          if (r.error) { msg.textContent = r.error.message; return; }
          msg.textContent = 'Confirmation email resent. Please check your inbox.';
        } catch (e) {
          msg.textContent = (e?.message || 'Could not resend confirmation email.');
        }
      };
    }
  };
  const authSigninBtn = document.getElementById('authSignin');
  if (authSigninBtn) authSigninBtn.onclick = async ()=>{
    if(!supabase){ document.getElementById('authMsg').textContent='Auth not configured (missing Supabase URL/Key).'; return; }
    const email = document.getElementById('authEmail').value.trim();
    const pass  = document.getElementById('authPass').value;
    const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
    const msg = document.getElementById('authMsg');
    if (error) { msg.textContent = error.message; return; }
    onSignedIn(email);
  };
  const authGoogleBtn = document.getElementById('authGoogle');
  if (authGoogleBtn) authGoogleBtn.onclick = async ()=>{
    if(!supabase){ document.getElementById('authMsg').textContent='Auth not configured (missing Supabase URL/Key).'; return; }
    const result = await supabase.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: window.location.origin + '/app.user.html' } });
    if (result && result.error) { document.getElementById('authMsg').textContent = result.error.message; return; }
  };

  
  // Export video function (FFmpeg backend)
  async function exportFinalVideo() {
    console.log('EXPORT CHECK:', { mediaType, selectedAudio });

    // Fail-safe: if list loaded but nothing selected, select first visible audio
    if (!selectedAudio) {
      const first = document.querySelector('#audioList audio');
      if (first && first.src) {
        selectedAudio = { preview: first.src };
        console.log('üéµ Fail-safe auto-select:', selectedAudio);
      }
    }

    if (mediaType === 'image') {
      if (!selectedAudio || !selectedAudio.preview) {
        alert('Please select background music');
        return;
      }

      hint.textContent = 'Creating video from image‚Ä¶ this may take ~20s';

      const file = mediaInput.files[0];
      if (!file) {
        alert('Image file missing');
        return;
      }

      const imageDataUrl = await fileToDataUrl(file);

      const res = await fetch(FFMPEG_IMAGE_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          imageBase64: imageDataUrl,
          audioUrl: selectedAudio.preview,
          duration: 7
        })
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); }
      catch { throw new Error(text.slice(0,200)); }

      if (!data.success) throw new Error(data.error || 'Image export failed');

      window.location.href = data.downloadUrl;
      hint.textContent = '';
      return;
    }

    if (mediaType !== 'video') {
      alert('Please upload a video first');
      return;
    }

    if (!selectedAudio || !selectedAudio.preview) {
      alert('Please select background music');
      return;
    }

    hint.textContent = 'Exporting video‚Ä¶ this may take ~30s';

    try {
      const file = mediaInput.files[0];
      if (!file) {
        alert('Video file missing');
        return;
      }

      const fd = new FormData();
      fd.append('video', file);
      fd.append('audioUrl', selectedAudio.preview);

      const res = await fetch(FFMPEG_API, {
        method: 'POST',
        body: fd
      });

      const text = await res.text();
      let data;
      try {
        data = JSON.parse(text);
      } catch {
        throw new Error(text.slice(0, 200));
      }
      if (!data.success) {
        throw new Error(data.error || 'Export failed');
      }

      if (data.downloadUrl) {
        window.location.href = data.downloadUrl;
      } else {
        const base = 'https://periproctic-maricela-nonpatently.ngrok-free.dev';
        window.location.href = `${base}/download?file=${encodeURIComponent(data.output)}`;
      }
      hint.textContent = '';
    } catch (e) {
      hint.textContent = 'Export failed: ' + e.message;
    }
  }
  // expose for safety
  window.exportFinalVideo = exportFinalVideo;

  async function generate(){
    // HARD BLOCK empty submit BEFORE building request
    if (!topic.value.trim() && !mediaType) {
      hint.textContent = 'Please enter a topic or upload an image/video.';
      return;
    }
    if (getCredits && getCredits() <= 0) { openAuth(); return; }
    out.innerHTML=''; hint.textContent='Generating‚Ä¶';

    let imageDataUrl = '';
    try{
      const f = (document.getElementById('media')||{}).files?.[0];
      if (f && mediaType === 'image') imageDataUrl = await fileToDataUrl(f);
    }catch{}

    try{
      const platforms = [...document.querySelectorAll('input[type=checkbox]:checked')].map(cb => cb.value);
      const res = await fetch('/api/generate', { 
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({
          prompt: topic.value,
          contentType: mediaType || 'text',
          platforms,
          imageDataUrl,
          videoMeta: mediaType === 'video' ? { duration: videoPreview.duration } : null,
          videoFrames: mediaType === 'video' ? (window._videoFrames || []) : [],
          selectedAudio: selectedAudio
        })
      });
      if (!res.ok) {
        if (res.status === 402) { openAuth(); return; }
        const text = await res.text().catch(()=>'');
        hint.textContent = 'Server error ('+res.status+'): ' + (text||'Check /api/generate exists and returns JSON.');
        return;
      }
      const j = await res.json();
      if (j.suggestedMood) {
        // Show audio box for both video and image
        const audioBox = document.getElementById('audioBox');
        audioBox.classList.remove('hidden');

        loadAudio(j.suggestedMood);
        hint.textContent = `Suggested background music: ${j.suggestedMood}`;
      }
      const caps = j.captions || {};
      // Normalize Instagram captions to always be an array
      let igCaps = [];
      if (Array.isArray(caps.instagram)) {
        igCaps = caps.instagram;
      } else if (caps.instagram && typeof caps.instagram === 'object') {
        igCaps = [caps.instagram];
      }

      igCaps.forEach(text => {
        const card = document.createElement('div');
        card.className = 'bg-black/30 border border-white/10 rounded-xl p-4';
        const pre = document.createElement('pre');
        pre.style.whiteSpace = 'pre-wrap';
        pre.style.margin = '0 0 .75rem 0';
        // --- Patch: handle object vs string for rendering
        if (typeof text === 'object' && text !== null) {
          const parts = [];
          if (text.hook) parts.push(`üî• ${text.hook}`);
          if (text.caption) parts.push(text.caption);
          if (Array.isArray(text.onscreen_text) && text.onscreen_text.length) {
            parts.push('\nOn-screen text:\n‚Ä¢ ' + text.onscreen_text.join('\n‚Ä¢ '));
          }
          pre.textContent = parts.join('\n\n');
        } else {
          pre.textContent = String(text);
        }

        // Render hashtags from backend (if present)
        const tagWrap = document.createElement('div');
        tagWrap.className = 'mt-2 pt-2 border-t border-white/10';
        const tagTitle = document.createElement('div');
        tagTitle.className = 'text-sm opacity-80 mb-1';
        tagTitle.textContent = 'Hashtags';
        const tagLine = document.createElement('div');
        tagLine.className = 'text-sm opacity-90 break-words';
        tagLine.textContent = (j.hashtags && j.hashtags.length) ? j.hashtags.join(' ') : '';

        // Actions
        const actions = document.createElement('div');
        actions.className = 'mt-3 flex gap-2';
        const copyCap = document.createElement('button');
        copyCap.className = 'rounded-lg border border-white/20 px-3 py-1.5 text-sm';
        copyCap.textContent = 'üìã Copy caption';
        copyCap.onclick = async () => {
          const copyText = (typeof text === 'object' && text !== null)
            ? [text.hook, text.caption].filter(Boolean).join('\n\n')
            : String(text);
          await navigator.clipboard.writeText(copyText);
          copyCap.textContent = '‚úÖ Copied';
          setTimeout(() => copyCap.textContent = 'üìã Copy caption', 1200);
        };
        const copyTags = document.createElement('button');
        copyTags.className = 'rounded-lg border border-white/20 px-3 py-1.5 text-sm';
        copyTags.textContent = 'üè∑Ô∏è Copy hashtags';
        copyTags.onclick = async () => {
          await navigator.clipboard.writeText(tagLine.textContent);
          copyTags.textContent = '‚úÖ Copied';
          setTimeout(() => copyTags.textContent = 'üè∑Ô∏è Copy hashtags', 1200);
        };

        tagWrap.appendChild(tagTitle);
        tagWrap.appendChild(tagLine);
        actions.appendChild(copyCap);
        actions.appendChild(copyTags);

        card.appendChild(pre);
        card.appendChild(tagWrap);
        card.appendChild(actions);
        out.appendChild(card);
      });
      setCredits(getCredits()-1);
      hint.textContent='';
    }catch(e){
      hint.textContent='Network error: '+ e.message + ' (Is /api/generate deployed?)';
    }
  }

  if (go) go.addEventListener('click', generate);
  const exportBtn = document.getElementById('exportBtn');
  if (exportBtn) exportBtn.addEventListener('click', exportFinalVideo);
// Helper links
(function handleAuthHelpers(){
  const msg = document.getElementById('authMsg');
  const fp = document.getElementById('forgotPass');
  const gg = document.getElementById('useGoogleHint');
  if (fp) fp.onclick = async () => {
    if(!supabase){ msg.textContent='Auth not configured.'; return; }
    const email = document.getElementById('authEmail').value.trim();
    if(!email){ msg.textContent='Enter your email first.'; return; }
    try {
      await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin + '/app.user.html' });
      msg.textContent = 'Password reset email sent.';
    } catch(e){ msg.textContent = (e?.message||e); }
  };
  if (gg) gg.onclick = () => {
    msg.innerHTML = 'If you signed up with Google, use <b>Continue with Google</b> to sign in.';
  };
})();
  console.log('index.html handlers attached');
});
</script>
</body>
</html>

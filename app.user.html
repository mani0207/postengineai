<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>postEngineAI ‚Äî Your captions</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--ig:linear-gradient(90deg,#F58529,#DD2A7B,#8134AF)}
    .ig{background-image:var(--ig)}
    .glass{background:rgba(255,255,255,.08);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px)}
    .chip{display:inline-block;background:#0e141b;color:#fff;border-radius:9999px;padding:.45rem .8rem}
  </style>
  <!-- Supabase Auth (needed to read the OAuth session after redirect) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta name="supabase-url" content="https://gstimoeysvzskmrnehfv.supabase.co">
  <meta name="supabase-anon" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzdGltb2V5c3Z6c2ttcm5laGZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4MjIwODgsImV4cCI6MjA3MzM5ODA4OH0.Pe9RUEHM1xK2qqK7n13M7ErAgZcuAVSGXDq1Yr2aP1o">
</head>
<body class="bg-slate-950 text-white">
  <header class="border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 h-14 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <img src="/header-logo-tight.png" alt="postEngineAI" class="h-8 w-auto">
        <span class="font-semibold text-lg bg-gradient-to-r from-[#F58529] via-[#DD2A7B] to-[#8134AF] bg-clip-text text-transparent">postEngineAI</span>
      </a>
      <nav class="text-sm flex items-center gap-3">
        <a href="#" id="signOutLink" class="opacity-90 hover:opacity-100">Sign out</a>
        <a href="/pay.html" class="rounded-lg bg-white text-black px-3 py-1.5 font-medium hover:opacity-90">Go Pro ($5/mo)</a>
      </nav>
    </div>
  </header>

  <!-- Password reset / set-password panel -->
<div id="pwPanel" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/60 px-4">
  <div class="w-full max-w-sm rounded-2xl border border-white/10 bg-black/85 text-white backdrop-blur p-6">
    <h3 class="text-lg font-semibold">Set your password</h3>
    <p class="mt-1 text-sm text-white/80">Choose a new password to use email sign-in next time.</p>
    <div class="mt-4 grid gap-3">
      <input id="pw1" type="password" placeholder="New password" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
      <input id="pw2" type="password" placeholder="Confirm password" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
      <button id="pwSave" class="rounded-lg bg-white text-black px-3 py-2 font-medium">Save password</button>
      <p id="pwMsg" class="text-sm text-white/80"></p>
    </div>
  </div>
</div>

  <!-- Inline Auth (only shows if no Supabase session) -->
<section id="inlineAuth" class="hidden ig">
  <div class="max-w-5xl mx-auto px-4 py-10">
    <div class="p-6 rounded-2xl border border-white/10 glass max-w-md">
      <h2 class="text-xl font-semibold">Sign in to continue</h2>
      <p class="mt-1 text-sm text-white/80">If you just signed up, confirm your email first.</p>
      <div class="mt-4 grid gap-3">
        <input id="authEmail2" type="email" placeholder="you@example.com" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
        <input id="authPass2" type="password" placeholder="Password" class="rounded-lg bg-black/40 border border-white/15 px-3 py-2">
        <button id="authSignin2" class="rounded-lg bg-white text-black px-3 py-2 font-medium">Sign in</button>
        <div class="text-center text-sm text-white/60">or</div>
        <button id="authGoogle2" class="rounded-lg bg-[#4285F4] px-3 py-2 font-medium">Continue with Google</button>
        <p id="authMsg2" class="text-sm text-white/80"></p>
      </div>
    </div>
  </div>
</section>

  <section class="ig">
    <div class="max-w-5xl mx-auto px-4 py-10">
      <h1 class="text-3xl sm:text-4xl font-bold">Welcome back üëã</h1>
      <p class="mt-2 text-white/90">
        You have a <b>20-caption free trial</b>. Upgrade anytime to <b>200/month</b> for just <b>$5/mo</b>.
      </p>
      
      <div class="mt-4">
        <a href="/pay.html" class="rounded-xl bg-white text-black px-5 py-3 font-semibold text-lg hover:opacity-90 inline-block">
          üöÄ Upgrade to Pro ‚Äî $5/mo
        </a>
      </div>
      
      <div class="mt-4 inline-flex items-center gap-2 bg-black/30 border border-white/10 rounded-xl px-3 py-2">
        <span>Captions left:</span><span id="credits">‚Äî</span>
      </div>
      <div class="mt-6 p-6 rounded-2xl border border-white/10 glass">
        <label class="block text-sm opacity-90">Describe your niche or post idea</label>
        <input id="topic" class="mt-2 w-full rounded-xl bg-black/30 border border-white/10 px-4 py-3 outline-none" placeholder="e.g., new smoothie reel, barbershop promo, travel tips" />

        <!-- Optional image or video (‚â§30s) -->
        <div class="mt-4 grid gap-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-2">
            <label for="media" class="text-sm opacity-90">Optional image or video (‚â§30s)</label>
            <input id="media" type="file" accept="image/*,video/*"
              class="text-sm file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0 file:bg-white file:text-black file:font-medium">
          </div>

          <img id="imgPreview"
            class="hidden mt-1 max-h-40 rounded-lg border border-white/10"
            alt="Selected image preview" />

          <video id="videoPreview"
            class="hidden mt-1 max-h-40 rounded-lg border border-white/10"
            controls></video>
        </div>
   

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <button id="go" class="rounded-xl bg-white text-black px-4 py-2 font-medium hover:opacity-90">Generate</button>
          <button id="exportBtn" class="rounded-xl border border-white/20 px-4 py-2 font-medium hover:bg-white/10">Export video</button>
          <span id="hint" class="opacity-80 text-sm"></span>
        </div>

        <!-- üéµ Background music selector (same as index.html) -->
        <div class="mt-6">
          <div class="flex items-center gap-2 text-sm opacity-90 mb-2">
            <span>üéµ</span>
            <span>Background music (royalty-free)</span>
          </div>

          <div class="flex flex-wrap gap-2">
            <button class="chip music-chip" data-mood="calm">Calm</button>
            <button class="chip music-chip" data-mood="energetic">Energetic</button>
            <button class="chip music-chip" data-mood="cinematic">Cinematic</button>
            <button class="chip music-chip" data-mood="vlog">Vlog</button>
          </div>

          <p class="mt-2 text-sm opacity-70">
            Background music is optional. You can export without audio or replace it later.
            Advanced audio editing is available in Pro.
          </p>
        </div>

        <div id="audioList" class="mt-4 grid gap-2"></div>
        <div id="out" class="mt-6 grid gap-4"></div>
      </div>
    </div>
  </section>

<script>
// ---- Auth guard (OAuth-aware) ----
function getCookie(k){
  return document.cookie.split(';').map(s=>s.trim()).filter(Boolean)
    .reduce((a,p)=>{const[i,...r]=p.split('=');a[i]=decodeURIComponent(r.join('='));return a;}, {})[k];
}

const SUPABASE_URL  = (document.querySelector('meta[name="supabase-url"]')||{}).content || '';
const SUPABASE_ANON = (document.querySelector('meta[name="supabase-anon"]')||{}).content || '';
const sb = (window.supabase && SUPABASE_URL && SUPABASE_ANON)
  ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON)
  : null;

(async function ensureSession(){
  try {
    if (!sb) {
      // No supabase client; fall back to cookie, otherwise show inline auth
      if (getCookie('pe_auth') !== '1') {
        document.getElementById('inlineAuth').classList.remove('hidden');
      }
      return;
    }
    const { data: { session } } = await sb.auth.getSession();
    if (session && session.user) {
      document.cookie = 'pe_auth=1; Path=/; SameSite=Lax; Max-Age='+(60*60*24*180);
    } else {
      // No session: show inline auth form instead of redirecting
      document.getElementById('inlineAuth').classList.remove('hidden');
    }
    sb.auth.onAuthStateChange((_event, s) => {
      if (!s) {
        document.cookie = 'pe_auth=; Path=/; Max-Age=0; SameSite=Lax';
        document.getElementById('inlineAuth').classList.remove('hidden');
      }
    });
  } catch (e) {
    console.error('Auth session check failed:', e);
    document.getElementById('inlineAuth').classList.remove('hidden');
  }
})();

// ---- Shared media state (must match index.html) ----
let mediaType = null; // 'image' | 'video'
window._selectedAudio = null;

const DEFAULT_MOOD = 'cinematic background';

  // ---- Credits UI (same as index.html) ----
  const creditsEl = document.getElementById('credits');

  function getCredits() {
    return parseInt(localStorage.getItem('pe_guest_credits') || '2', 10);
  }

  function setCredits(n) {
    localStorage.setItem('pe_guest_credits', String(Math.max(0, n)));
    if (creditsEl) creditsEl.textContent = getCredits();
  }

  // ---- Image helpers (kept 1:1 with index.html) ----
  function fileToDataUrl(file){
    return new Promise((resolve,reject)=>{
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }
  const mediaInput = document.getElementById('media');
  const imgPreview = document.getElementById('imgPreview');
  const videoPreview = document.getElementById('videoPreview');

  if (mediaInput) {
    mediaInput.addEventListener('change', async () => {
      const file = mediaInput.files?.[0];
      if (!file) return;

      window._selectedAudio = null;
      // üéµ Auto-load music suggestions on media upload (match index.html)
      loadAudio(DEFAULT_MOOD);
      hint.textContent = `Suggested music: ${DEFAULT_MOOD}`;

      if (file.type.startsWith('image/')) {
        mediaType = 'image';

        const reader = new FileReader();
        reader.onload = () => {
          imgPreview.src = reader.result;
          imgPreview.classList.remove('hidden');
          videoPreview.classList.add('hidden');
          videoPreview.src = '';
        };
        reader.readAsDataURL(file);
      }

      else if (file.type.startsWith('video/')) {
        mediaType = 'video';

        videoPreview.src = URL.createObjectURL(file);
        videoPreview.classList.remove('hidden');
        imgPreview.classList.add('hidden');
        imgPreview.src = '';
      }
    });
  }

  // ---- Generate ----
  const topic=document.getElementById('topic');
  const go=document.getElementById('go');
  const hint=document.getElementById('hint');
  const out=document.getElementById('out');

  async function generate(){
    out.innerHTML=''; hint.textContent='Generating‚Ä¶';

    let imageDataUrl = '';
    if (mediaType === 'image') {
      const f = document.getElementById('media')?.files?.[0];
      if (f) imageDataUrl = await fileToDataUrl(f);
    }

    try{
      const res = await fetch('/api/generate', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ prompt: topic.value, imageDataUrl })
      });
      if (res.status === 402) {
        hint.textContent = 'Free limit reached. Please upgrade to Pro.';
        return;
      }
      if (!res.ok) {
        const text = await res.text().catch(()=> '');
        hint.textContent = 'Server error ('+res.status+'): '+(text||'');
        return;
      }
      const j = await res.json();

      // üîä Auto-suggest background music (same behavior as index.html)
      const mood = j.suggestedMood || 'cinematic background';
      loadAudio(mood);
      hint.textContent = `Suggested music: ${mood}`;

      // Update credits after successful generation
      if (typeof j.remaining === 'number') {
        setCredits(j.remaining);
      }

      // Render cards (captions + hashtags + actions), same as index.html
      (j.captions||[]).forEach(text=>{
        const card=document.createElement('div'); card.className='bg-black/30 border border-white/10 rounded-xl p-4';
        const pre=document.createElement('pre'); pre.style.whiteSpace='pre-wrap'; pre.style.margin='0 0 .75rem 0'; pre.textContent=text;

        const tagWrap=document.createElement('div'); tagWrap.className='mt-2 pt-2 border-t border-white/10';
        const tagTitle=document.createElement('div'); tagTitle.className='text-sm opacity-80 mb-1'; tagTitle.textContent='Hashtags';
        const tagLine=document.createElement('div'); tagLine.className='text-sm opacity-90 break-words';
        tagLine.textContent = (j.hashtags && j.hashtags.length) ? j.hashtags.join(' ') : '';

        const actions=document.createElement('div'); actions.className='mt-3 flex gap-2';
        const copyCap=document.createElement('button'); copyCap.className='rounded-lg border border-white/20 px-3 py-1.5 text-sm'; copyCap.textContent='üìã Copy caption';
        copyCap.onclick=async()=>{await navigator.clipboard.writeText(text);copyCap.textContent='‚úÖ Copied';setTimeout(()=>copyCap.textContent='üìã Copy caption',1200);};
        const copyTags=document.createElement('button'); copyTags.className='rounded-lg border border-white/20 px-3 py-1.5 text-sm'; copyTags.textContent='üè∑Ô∏è Copy hashtags';
        copyTags.onclick=async()=>{await navigator.clipboard.writeText(tagLine.textContent);copyTags.textContent='‚úÖ Copied';setTimeout(()=>copyTags.textContent='üè∑Ô∏è Copy hashtags',1200);};

        tagWrap.appendChild(tagTitle); tagWrap.appendChild(tagLine);
        actions.appendChild(copyCap); actions.appendChild(copyTags);

        card.appendChild(pre);
        card.appendChild(tagWrap);
        card.appendChild(actions);
        out.appendChild(card);
      });

      hint.textContent='';
    }catch(e){ hint.textContent='Network error: '+ e.message; }
  }
  go.addEventListener('click', generate);

async function loadAudio(mood){
  const list = document.getElementById('audioList');
  hint.textContent = `Loading ${mood} music‚Ä¶`;
  list.innerHTML = '<div class="opacity-70">Loading tracks‚Ä¶</div>';

  try {
    const res = await fetch('/api/audio-search',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ mood })
    });
    if (!res.ok) throw new Error(`Audio API ${res.status}`);

    const j = await res.json();
    const items = Array.isArray(j) ? j : (j.results || []);

    list.innerHTML = '';
    let autoSelected = false;

    items.slice(0,5).forEach((a, idx)=>{
      const row = document.createElement('div');
      row.className = 'flex items-center gap-2 bg-black/30 border border-white/10 rounded-lg p-2';

      const audio = document.createElement('audio');
      audio.src = a.preview;
      audio.controls = true;

      const use = document.createElement('button');
      use.className = 'rounded-lg border border-white/20 px-3 py-1.5 text-sm';
      use.textContent = 'Use';
      use.onclick = ()=>{
        window._selectedAudio = { preview: a.preview };
        [...list.children].forEach(c=>c.classList.remove('ring-2','ring-white'));
        row.classList.add('ring-2','ring-white');
        hint.textContent = 'Background music selected ‚úì';
      };

      row.appendChild(audio);
      row.appendChild(use);
      list.appendChild(row);

      // auto-select first track
      if (!autoSelected && idx === 0 && a.preview){
        window._selectedAudio = { preview: a.preview };
        row.classList.add('ring-2','ring-white');
        autoSelected = true;
        hint.textContent = 'Background music auto-selected ‚úì';
      }
    });

    if (!items.length){
      list.innerHTML = '<div class="opacity-70">No tracks found.</div>';
      hint.textContent = 'No music found.';
    }
  } catch(e){
    list.innerHTML = '<div class="opacity-70">Failed to load audio</div>';
    hint.textContent = 'Failed to load audio.';
  }
}

window.loadAudio = loadAudio;

  // ---- Music mood chips (same as index.html) ----
  document.querySelectorAll('.music-chip').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mood = btn.dataset.mood;
      loadAudio(mood);
      hint.textContent = `Suggested music: ${mood}`;
    });
  });

const FFMPEG_API = 'http://163.192.104.44:3001';
const FFMPEG_IMAGE_API = `${FFMPEG_API}/export-image`;

async function exportFinalVideo(){
  console.log('Export check ‚Üí selectedAudio:', window._selectedAudio);

  if (!window._selectedAudio || !window._selectedAudio.preview){
    alert('Please select background music');
    return;
  }

  hint.textContent = 'Exporting‚Ä¶ this may take ~30s';

  try {
    // üñºÔ∏è IMAGE ‚Üí VIDEO
    if (mediaType === 'image') {
      const file = document.getElementById('media')?.files?.[0];
      if (!file) {
        alert('Image missing');
        return;
      }

      const imageDataUrl = await fileToDataUrl(file);

      const res = await fetch(FFMPEG_IMAGE_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          imageBase64: imageDataUrl,
          audioUrl: window._selectedAudio.preview,
          duration: 7
        })
      });

      const data = await res.json();
      if (!data.success) throw new Error(data.error || 'Image export failed');

      window.location.href = data.downloadUrl;
      hint.textContent = '';
      return;
    }

    // üé• VIDEO
    if (mediaType !== 'video') {
      alert('Please upload an image or video first');
      return;
    }

    const res = await fetch(`${FFMPEG_API}/export`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        videoUrl: videoPreview.src,
        audioUrl: window._selectedAudio.preview
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Export failed');

    window.location.href = `${FFMPEG_API}${data.downloadUrl}`;
    hint.textContent='';
  } catch(e){
    hint.textContent = 'Export failed: ' + e.message;
  }
}

window.exportFinalVideo = exportFinalVideo;

const exportBtn=document.getElementById('exportBtn');
if (exportBtn) exportBtn.addEventListener('click', exportFinalVideo);

  // ---- Initialize credits on page load ----
  if (creditsEl) {
    creditsEl.textContent = getCredits();
  }

  // ---- Sign out: clear cookie and go back to guest landing ----
    (function(){
    const el = document.getElementById('signOutLink');
    if(!el) return;
    el.addEventListener('click', async (e)=>{
      e.preventDefault();
      try {
        if (sb) { await sb.auth.signOut(); } // <-- real sign-out
      } catch {}
      document.cookie = 'pe_auth=; Path=/; Max-Age=0; SameSite=Lax';
      window.location.href = '/';
    });
  })();

  (function attachInlineAuth(){
    if (!sb) return;
    const btn = document.getElementById('authSignin2');
    const msg = document.getElementById('authMsg2');
    const em  = document.getElementById('authEmail2');
    const pw  = document.getElementById('authPass2');
    const gg  = document.getElementById('authGoogle2');

    if (btn) btn.onclick = async () => {
      try {
        const { error } = await sb.auth.signInWithPassword({ email: em.value.trim(), password: pw.value });
        if (error) {
          // Helpful hints for the common cases
          if (/Invalid login credentials/i.test(error.message)) {
            msg.innerHTML = `Invalid login credentials.
              <br/>‚Ä¢ If you signed up with Google, use <b>Continue with Google</b>.
              <br/>‚Ä¢ Or click <b>Forgot password</b> on the homepage to set a password for this email.`;
          } else if (/Email not confirmed/i.test(error.message)) {
            msg.textContent = 'Please confirm your email first (check your inbox).';
          } else {
            msg.textContent = error.message;
          }
          return;
        }
        // success: hide inline form and refresh page UI
        location.reload();
      } catch(e){ msg.textContent = e?.message || 'Could not sign in.'; }
    };

    if (gg) gg.onclick = async ()=>{
      const r = await sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: window.location.origin + '/app.user.html' } });
      if (r?.error) msg.textContent = r.error.message;
    };
  })();
</script>
</body>
</html>